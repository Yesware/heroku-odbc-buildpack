#!/bin/sh

BUILD_DIR=$1

#
# install the unixodbc driver first as it has some files that
# are needed for Snowflake ODBC
#
#echo '-----> Installing unix ODBC'
#curl http://www.unixodbc.org/unixODBC-2.3.4.tar.gz | tar xvz --directory $BUILD_DIR
#$BUILD_DIR/unixODBC-2.3.4/install-sh -t $BUILD_DIR

#
# now install the Snowflake ODBC
#
echo "-----> Installing Snowflake ODBC driver into $BUILD_DIR"
tar -xzf support/snowflake_linux_x8664_odbc.tgz --directory "/tmp"
cd /tmp/snowflake_odbc
/tmp/snowflake_odbc/unixodbc_setup.sh

#
# now install the ruby-odbc Gem
#
echo '------> Installing ruby-odbc Gem'
curl http://www.ch-werner.de/rubyodbc/ruby-odbc-0.99998.tar.gz | tar xvz --directory $BUILD_DIR
echo 'ls tmp'
ls $BUILD_DIR
cd $BUILD_DIR/ruby-odbc-0.99998/
echo '------> Generating Makefile'
ruby -C ext extconf.rb --enable-dlopen
echo '------> Building ruby-odbc'
make -C ext
echo '------> Installing ruby-odbc'
make -C ext install RUBYARCHDIR="${BUILD_DIR}/lib/x86_64-linux-gnu"

ldd $BUILD_DIR/lib/x86_64-linux-gnu/odbc.so

#
# now install the ActiveRecord ODBC Adapter Gem
#
echo '------> Installing ActiveRecord ODBC Adapter'
gem install activerecord-odbc-adapter -i $BUILD_DIR

#
# install the Localytics ODBC Adapter
#
echo '-------> Installing odbc_adapter'
gem install odbc_adapter
